if(!window.console)window.console={log:function(){},warn:function(){},error:function(){},fatal:function(){},debug:function(){},dir:function(){}};
(function(c,e,f){var k={SAVE_SUCCESS:"\u4fdd\u5b58\u6210\u529f.",SAVING:"\u6b63\u5728\u4fdd\u5b58...",JSON_PARSE_ERROR:"\u65e0\u6cd5\u89e3\u6790\u670d\u52a1\u5668\u8fd4\u56de\u7684\u6570\u636e"};e.i18n.extend("Editor",k);var j={version:0.1,isReady:false,element:null,titleElem:null,bodyElem:null,resizer:null,titleLength:-1,bodyLength:-1,updater:null,settings:{element:"#diary",formElem:"#form_diary",titleElem:"#diary_title",idElem:"#diary_id",bodyElem:"#diary_content",containerElem:".diary_container",
ajaxSetup:{},saveUrl:Ediary.baseUrl+"/diary/do/save",deleteUrl:""},plugins:{},events:new Ediary.Events,init:function(a){var b=this;a=c.extend(this.settings,a);if(this.checkDOMIsReady()){this.element=c(a.element);this.bodyElem=c(a.bodyElem);this.titleElem=c(a.titleElem);this.containerElem=c(a.containerElem);this.bodyLength=this.bodyElem.val().length;this.titleLength=this.titleElem.val().length;this.initPlugins();this.setupAjax();this.setupTinyMCE();this.resizer=setInterval(function(){b.resize()},500);
this.isReady=true;return this}},setupTinyMCE:function(){typeof f.tinyMCE=="undefined"&&e.include(e.baseUrl+"/js/tiny_mce/tiny_mce.js");f.tinyMCE.init({mode:"exact",elements:this.bodyElem.attr("id"),width:this.bodyElem.width(),height:this.bodyElem.height(),plugins:"safari,paste,inlinepopups,spellchecker,insertdatetime,nonbreaking",theme:"advanced",skin:"default",content_css:e.baseUrl+"/css/rte.css",theme_advanced_buttons1:"bold,italic,underline,|,fontselect,fontsizeselect,forecolor,|,justifyleft,justifycenter,justifyright,|,indent,outdent,|,strikethrough,backcolor,|,bullist,numlist,|,spellchecker,insertdate,link,removeformat",
theme_advanced_buttons2:"",theme_advanced_buttons3:"",theme_advanced_toolbar_location:"none",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"none",theme_advanced_resizing:true,invalid_elements:"embed,object,script,form",entity_encoding:"raw",paste_convert_middot_lists:true,paste_remove_spans:true,paste_remove_styles:true,paste_strip_class_attributes:true,nonbreaking_force_tab:true,convert_urls:false,setup:function(a){c.browser.msie&&a.onPostRender.add(function(b){if(c.browser.msie){c("iframe",
c(b.getContentAreaContainer())).attr("allowTransparency","true");c(b.getBody()).css("background","transparent")}})},template_replace_values:{}})},checkDOMIsReady:function(){var a=this.settings,b=["element","titleElem","bodyElem","containerElem","formElem"];for(var d in b){d=b[d];if(c(a[d]).length<1){console.error(d+" DOM element is missing,  it should be : "+a[d]);return false}}return true},addPlugin:function(a,b,d){if(b instanceof e.Plugin)if(typeof this.plugins[a]==="undefined"){this.plugins[a]=
b;this.plugins[a].addExt(d)}else console.warn("Editor already has a Plugin named as "+a);else console.warn("Editor.addPlugin expect a Object instance of Plugin.  Plugin name: "+a)},initPlugins:function(){c.each(this.plugins,function(){this.delayInit()})},addListener:function(a,b){b=new e.Listener(b);this.events.addListener(a,b)},hook:function(a,b){this.events.callListener(a,b)},callback:function(a){typeof this[a]==="function"&&this[a].call(this)},resize:function(){var a=this.getRTEditor(),b,d,i,h,
g={minHeight:815,increment:815,margin:0};if(a){b=c("iframe",c(a.getContentAreaContainer()));d=b.height();i=c.browser.chrome?c(a.getBody()).insideHeight():c(a.getBody()).height();g.margin=40}else if(!this.isLocked()){b=this.bodyElem;d=b.height();i=b.get(0).scrollHeight}if(b){if(d<i+g.margin||d-g.increment>i+g.margin)h=Math.ceil((i+g.margin)/g.increment)*g.increment;if(h){h=Math.max(g.minHeight,h);b.css("height",h+"px");this.containerElem.css("height",h+"px")}}},isLocked:function(){return this.titleElem.attr("readonly")||
this.bodyElem.attr("readonly")},getRTEditor:function(){var a;try{a=f.tinyMCE.get(this.bodyElem.attr("id"))}catch(b){a=null}return a},updateValues:function(a){this.setTitle(a.title);this.setContent(a.content)},getValues:function(){return{title:this.getTitle(),content:this.getContent()}},updateId:function(){console.log("update Id");c(this.settings.idElem).val(this.getCache("diary").id)},isEmpty:function(){return 0==this.titleElem.val().length&&0==this.bodyElem.val().length},isChanged:function(){return this.titleElem.val().length!==
this.titleLength||this.bodyElem.val().length!==this.bodyLenght},startAutoSave:function(){var a=this;this.updater=setInterval(function(){a.doSave()},a.AUTO_SAVE_INTERVAL)},stopAutoSave:function(){if(this.updater){clearInterval(this.updater);this.updater=null}},stopResizer:function(){if(this.resizer){clearInterval(this.resizer);this.resizer=null}},doSave:function(a){try{var b=this;a=a||false;var d=this.getRTEditor(),i=c(this.settings.formElem);d&&d.isDirty()&&d.save();if(a||!this.isEmpty()&&this.isChanged()){console.log("do save");
c.ajax({url:b.settings.saveUrl,type:"POST",data:i.serialize(),dataType:"json",beforeSendMessage:k.SAVING,success:function(g){b.onSaveDone(g);b.hook("onSaveDone",arguments)}})}}catch(h){console.log("error by dosave :"+h)}},onSaveDone:function(a){console.log("Get data form server : "+a);console.dir(a);if(a.error)e.Notice.showMessage(a.error);else{e.Notice.showMessage(k.SAVE_SUCCESS,1E3);this.cache("diary",a.diary);a.callback&&this.callback(a.callback)}},doDelete:function(){console.log("do delete")},
setupAjax:function(){var a=this;c.extend(this.settings.ajaxSetup,{error:function(b,d){if("parsererror"==d){console.warn("Response is not a valid JSON Object, Cann't parse it. Response is: \n",b.responseText);e.Notice.showMessage(k.JSON_PARSE_ERROR)}a.hook("onError",arguments)},beforeSend:function(b,d){d.beforeSendMessage&&e.Notice.showMessage(d.beforeSendMessage);a.hook("onBeforeSend",arguments)}});c.ajaxSetup(this.settings.ajaxSetup)},cache:function(a,b){this.element.data(a,b)},getCache:function(a){return this.element.data(a)},
setTitle:function(a){this.titleElem.val(a)},getTitle:function(){return this.titleElem.val()},setContent:function(a){this.getRTEditor()?this.getRTEditor().setContent(a):this.bodyElem.val(a)},getContent:function(){return this.getRTEditor()?this.getRTEditor().getContent():this.bodyElem.val()},destroy:function(){this.stopAutoSave();this.stopResizer();f.tinyMCE&&this.getRTEditor()&&this.getRTEditor().remove();this.bodyElem=this.titleElem=this.element=null;c.each(this.plugins,function(){this.destroy()})}};
e.extend("Editor",j);j=Class.extend({init:function(){this.element=null;this.extData={}},delayInit:function(){},addExt:function(a){c.extend(this.extData,a)},destroy:function(){}});e.Plugin=j;j=j.extend({options:{element:"#editor-btn-save"},init:function(){this._super();c.extend(this.options,this.extData);var a=this.options;this.element=c(a.element);this.element.length<1&&console.warn("Save Button is missing, it should be :",a.element);this.bindEvent()},bindEvent:function(){this.element.click(this.clickHandler)},
clickHandler:function(){console.log("click save btn");e.Editor.doSave();return false},destroy:function(){this.element.unbind()}});e.SaveButton=j})(jQuery,Ediary,window);(function(c,e){e.extend("Pad",{options:{editor:{},notice:{}},init:function(f){this.initEditor(f);return this},initEditor:function(f){c.extend(this.options,f);f=e.Editor.init(this.options.editor);f.addListener("onSaveSuccess",function(){});f.addPlugin("SaveButton",new e.SaveButton)},destroy:function(){}})})(jQuery,Ediary,window);
