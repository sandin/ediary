<?php
require_once 'PHPUnit/Framework.php';

/**
 * Test class for Ediary_User.
 * Generated by PHPUnit on 2011-02-26 at 14:23:54.
 */
class Ediary_UserTest extends ControllerTestCase
{
    /**
     * @var Ediary_User
     */
    protected $object;
    
    protected $data = array();
    
    public function dataProvider() {
        return array(
            array('lds2012@gmail.com', 'password', 'username', true),
        );
    }

    /**
     * Sets up the fixture, for example, opens a network connection.
     * This method is called before a test is executed.
     */
    protected function setUp()
    {
        parent::setUp();
        $this->object = new Ediary_User();
        
        $r = substr(microtime(), 3, 7); // random string
        $this->data['email'] = $r . 'lds2012@gmail.com';
        $this->data['name'] = "username";
        $this->data['password'] = 'asdfzf34sdfa';
    }

    /**
     * Tears down the fixture, for example, closes a network connection.
     * This method is called after a test is executed.
     */
    protected function tearDown()
    {
    }

    /**
     * @todo Implement testGetName().
     */
    public function testGetName()
    {
        // Remove the following lines when you implement this test.
        $this->markTestIncomplete(
          'This test has not been implemented yet.'
          );
    }

    /**
     * @todo Implement testGetId().
     */
    public function testGetId()
    {
        // Remove the following lines when you implement this test.
        $this->markTestIncomplete(
          'This test has not been implemented yet.'
          );
    }

    /**
     * @todo Implement testNewFromRow().
     */
    public function testNewFromRow()
    {
        // Remove the following lines when you implement this test.
        $this->markTestIncomplete(
          'This test has not been implemented yet.'
          );
    }

    /**
     * @todo Implement testLoadFromRow().
     */
    public function testLoadFromArray()
    {
        $mockRow = array(
            Ediary_User::ID => '1234',
            Ediary_User::NAME => 'lds',
            Ediary_User::EMAIL => 'lds2012@gmail.com',
            Ediary_User::ACCOUNT => '100000000',
            Ediary_User::CREATED => '2010-12-21 12:12:12',
            Ediary_User::LAST_TIME => '2011-12-23 12:12:12',
            Ediary_User::PIC => 'dsafas421423',
            Ediary_User::PASSWORD => 'dsafas13421423',
            Ediary_User::SECURITY_CODE => 'dsafadsfs13421423',
        );
        $user = $this->object->loadFromArray($mockRow);
        
        $this->assertEquals($mockRow[Ediary_User::ID], $user->getId());
        $this->assertEquals($mockRow[Ediary_User::EMAIL], $user->mEmail);
        $this->assertEquals($mockRow[Ediary_User::NAME], $user->mName);
        $this->assertEquals($mockRow[Ediary_User::ACCOUNT], $user->mAccount);
        $this->assertEquals($mockRow[Ediary_User::CREATED], $user->mCreated);
        $this->assertEquals($mockRow[Ediary_User::LAST_TIME], $user->mLastTime);
        $this->assertEquals($mockRow[Ediary_User::PIC], $user->mPic);
        
        $this->assertTrue($user->isLoad());
    }

    /**
     * depend User#create()
     */
    public function testLoadById()
    {
        // create a user and load it by id
        $userId = $this->_createUser();
        $this->assertTrue($userId > 0);
        $user = $this->object->loadById($userId);
        
        $this->assertEquals($userId, $user->getId());
        $this->assertEquals($this->data['email'], $user->mEmail);
    }
    
    /**
     * depend User#create()
     */
    public function testLoadByEmail()
    {
        // create a user and load it by email
        $userId = $this->_createUser();
        $user = $this->object->loadByEmail($this->data['email']);
        
        $this->assertEquals($userId, $user->getId());
        $this->assertEquals($this->data['email'], $user->mEmail);
    }

    /**
     * @todo Implement testInsert().
     */
    public function testCreate()
    {
        $userId = $this->_createUser();
        $this->assertTrue($userId > 0);
    }
    
    /**
     * @dataProvider dataProvider
     */
    public function testCreate2($email, $password, $name, $valid) {
        /*
        $userId = $this->_createUser2($email, $password, $name);
        if ($valid) {
            $this->assertTrue($userId > 0);
        } else {
            $this->assertEquals(-1, $userId); // return -1 on fail
        }
        */
    } 
    
    public function testLogin() {
        $userId = $this->_createUser();
        $email = $this->data['email'];
        $password = $this->data['password'];
        
        $result_fail = Ediary_User::login($email, 'wrong password');
        $result_ok = Ediary_User::login($email, $password);
        
        $this->assertFalse($result_fail->result);
        $this->assertNotNull($result_fail->message); // has a message on fail
        $this->assertTrue($result_ok->result);
    }

    private function _createUser() {
        return $userId = $this->object->create(
            $this->data['email'],
            $this->data['password'],
            $this->data['name']
        );
    }
    
    private function _createUser2($email, $password, $name) {
        return $userId = $this->object->create(
            $email, $password, $name
        );
    }

    /**
     * @todo Implement testDelete().
     */
    public function testDelete()
    {
        // Remove the following lines when you implement this test.
        $this->markTestIncomplete(
          'This test has not been implemented yet.'
          );
    }

    /**
     * @todo Implement testUpdate().
     */
    public function testUpdate()
    {
        // Remove the following lines when you implement this test.
        $this->markTestIncomplete(
          'This test has not been implemented yet.'
          );
    }

    public function testIsExistsEmail() {
        // pre check
        $this->assertFalse(Ediary_User::isExistsEmail($this->data['email']));

        // create user
        $userId = $this->_createUser();
        
        // post check
        $this->assertTrue(Ediary_user::isExistsEmail($this->data['email']));
        
        // test isExistsId()
        $this->assertTrue(Ediary_user::isExistsId($userId));
        $this->assertFalse(Ediary_user::isExistsId('unExistsUserId'));
    }
    
    // depends : Ediary_Journal::create()
    public function testGetJournals() {
        // create a user
        $userId = $this->_createUser();
        
        // create a journal for this test 
        $journal_data = array( 'title' => 'title', 'user_id' => $userId);
        $journal = Ediary_Journal::create($journal_data);
        $this->assertNotNull($journal->id);
        
        // find the user who just created
        $user = new Ediary_User();
        $user->find($userId);
        $this->assertEquals($userId, $user->getId());
        
        // get this user's journals
        $journals_from_db = $user->getJournals();
        //var_dump($journals_from_db);
        
        // the user is a new guy, so he only has one journal 
        $this->assertEquals(1, count($journals_from_db));
        $this->assertEquals($journal->id, $journals_from_db[0]->id);
    }
    
    public function emailDataProvider() {
        return array( 
            array('lds2012@gmail.com', true),
            array('lds2012@noexists.com', true), 
            array('lds2012@noexists.cn', true), 
            array('lds2012@noexists.com.cn', true), 
            array('lds2012@noexists.org', true), 
            
            array('lds2012gmail.com', false),
            array('lds2012@gmailcom', false),
            array('asdfajjklsdfaoihosdfa', false)
        );
    }
    
    /**
     * @dataProvider emailDataProvider
     */
    public function testIsValidEmail($email, $isValid) {
        $this->assertEquals($isValid, Ediary_User::isValidEmail($email));
    }
    
    // for testIsValidUser
    public function usernameDataProvider() {
        return array(
            array('lastname', true),
            array('firstname lastname',true),    // white space is allowed
            array('firstname_lastname', false),  // "_" is not allowed
            array('firstname-lastname', false),  // "-" is not allowed
            array('323423lastname', true),       // start with num
            array('lastname1234', true),         // end with num
            array('1234234234234', true),        // all num
            array('中文名', false)
        );
    }
        
    /**
     * @dataProvider usernameDataProvider
     */
    public function testIsValidUser($name, $isValid) {
        if ($isValid !== Ediary_user::isValidUserName($name)) {
            $this->fail($name . ' is invalid.');
        }
    }
    
    // for testIsValidPassword
    public function passwordDataProvider() {
        return array(
            array('123456', false),    // too short
            array('12345678901234567890', false), // too long
            array('abcdefgh', true),   
            array('a2345678', true),   
            array('12345678', true),  
            array('1234567c', true),   
            array('asdf1234214sDFSF', true) // prefect password
        );
    }
    
    /**
     * @dataProvider passwordDataProvider
     */
    public function testIsValidPassword($password, $isValid) {
        if ($isValid !== Ediary_user::isValidPassword($password)) {
            $this->fail($password . ' is invalid.');
        }
    }
    
}
?>
